import telebot
import re
from telebot import types


TOKEN = "8464030671:AAEbX1jCkEoONyTHbJDI_uH14M422jSJECQ"


library_catalog = {
    "александр сергеевич пушкин": {
        "книги": [
            {"название": "Капитанская дочка", "страниц": 160, "количество": 5, "место": "Абонемент, стеллаж 1, полка 3"},
            {"название": "Руслан и Людмила", "страниц": 192, "количество": 2, "место": "Абонемент, стеллаж 1, полка 3"},
            {"название": "Пиковая дама", "страниц": 96, "количество": 4, "место": "Абонемент, стеллаж 1, полка 3"},
            {"название": "Сказка о царе Салтане", "страниц": 48, "количество": 6, "место": "Читальный зал, стеллаж 5, полка 2"}
        ]
    },
    "лев николаевич толстой": {
        "книги": [
            {"название": "Война и мир (Том 1)", "страниц": 736, "количество": 2, "место": "Абонемент, стеллаж 2, полка 1"},
            {"название": "Война и мир (Том 2)", "страниц": 704, "количество": 2, "место": "Абонемент, стеллаж 2, полка 1"},
            {"название": "Анна Каренина", "страниц": 864, "количество": 1, "место": "Абонемент, стеллаж 2, полка 1"},
            {"название": "Детство", "страниц": 128, "количество": 3, "место": "Абонемент, стеллаж 2, полка 2"},
            {"название": "Кавказский пленник", "страниц": 64, "количество": 4, "место": "Читальный зал, стеллаж 5, полка 1"}
        ]
    },
    "фёдор михайлович достоевский": {
        "книги": [
            {"название": "Преступление и наказание", "страниц": 672, "количество": 2, "место": "Абонемент, стеллаж 2, полка 3"},
            {"название": "Идиот", "страниц": 640, "количество": 1, "место": "Абонемент, стеллаж 2, полка 3"},
            {"название": "Братья Карамазовы", "страниц": 848, "количество": 1, "место": "Абонемент, стеллаж 2, полка 3"},
            {"название": "Белые ночи", "страниц": 96, "количество": 3, "место": "Читальный зал, стеллаж 5, полка 2"}
        ]
    },
    "николай васильевич гоголь": {
        "книги": [
            {"название": "Мёртвые души", "страниц": 416, "количество": 4, "место": "Абонемент, стеллаж 1, полка 5"},
            {"название": "Ревизор", "страниц": 128, "количество": 5, "место": "Абонемент, стеллаж 1, полка 5"},
            {"название": "Вий", "страниц": 64, "количество": 2, "место": "Абонемент, стеллаж 1, полка 5"},
            {"название": "Тарас Бульба", "страниц": 176, "количество": 3, "место": "Абонемент, стеллаж 1, полка 5"},
            {"название": "Нос", "страниц": 48, "количество": 2, "место": "Читальный зал, стеллаж 5, полка 3"}
        ]
    },
    "михаил юрьевич лермонтов": {
        "книги": [
            {"название": "Герой нашего времени", "страниц": 192, "количество": 4, "место": "Абонемент, стеллаж 1, полка 4"},
            {"название": "Мцыри", "страниц": 64, "количество": 3, "место": "Абонемент, стеллаж 1, полка 4"},
            {"название": "Демон", "страниц": 96, "количество": 2, "место": "Читальный зал, стеллаж 5, полка 2"}
        ]
    },
    "антон павлович чехов": {
        "книги": [
            {"название": "Вишнёвый сад", "страниц": 96, "количество": 3, "место": "Абонемент, стеллаж 3, полка 1"},
            {"название": "Чайка", "страниц": 80, "количество": 2, "место": "Абонемент, стеллаж 3, полка 1"},
            {"название": "Три сестры", "страниц": 112, "количество": 2, "место": "Абонемент, стеллаж 3, полка 1"},
            {"название": "Каштанка", "страниц": 64, "количество": 5, "место": "Читальный зал, стеллаж 6, полка 1"},
            {"название": "Палата №6", "страниц": 128, "количество": 2, "место": "Абонемент, стеллаж 3, полка 1"}
        ]
    },
    "иван сергеевич тургенев": {
        "книги": [
            {"название": "Отцы и дети", "страниц": 288, "количество": 3, "место": "Абонемент, стеллаж 3, полка 2"},
            {"название": "Муму", "страниц": 48, "количество": 6, "место": "Читальный зал, стеллаж 6, полка 1"},
            {"название": "Ася", "страниц": 64, "количество": 4, "место": "Абонемент, стеллаж 3, полка 2"},
            {"название": "Дворянское гнездо", "страниц": 224, "количество": 2, "место": "Абонемент, стеллаж 3, полка 2"}
        ]
    },
    "александр исаевич солженицын": {
        "книги": [
            {"название": "Один день Ивана Денисовича", "страниц": 160, "количество": 2, "место": "Абонемент, стеллаж 4, полка 1"},
            {"название": "Матрёнин двор", "страниц": 64, "количество": 1, "место": "Читальный зал, стеллаж 6, полка 2"}
        ]
    },
    "джоан роулинг": {
        "книги": [
            {"название": "Гарри Поттер и философский камень", "страниц": 432, "количество": 3, "место": "Абонемент, стеллаж 7, полка 1"},
            {"название": "Гарри Поттер и тайная комната", "страниц": 480, "количество": 2, "место": "Абонемент, стеллаж 7, полка 1"},
            {"название": "Гарри Поттер и узник Азкабана", "страниц": 512, "количество": 2, "место": "Абонемент, стеллаж 7, полка 1"},
            {"название": "Гарри Поттер и Кубок огня", "страниц": 672, "количество": 1, "место": "Абонемент, стеллаж 7, полка 1"}
        ]
    },
    "джон рональд руэл толкин": {
        "книги": [
            {"название": "Хоббит", "страниц": 320, "количество": 2, "место": "Абонемент, стеллаж 7, полка 2"},
            {"название": "Властелин колец: Братство кольца", "страниц": 544, "количество": 1, "место": "Абонемент, стеллаж 7, полка 2"},
            {"название": "Властелин колец: Две крепости", "страниц": 448, "количество": 1, "место": "Абонемент, стеллаж 7, полка 2"},
            {"название": "Властелин колец: Возвращение короля", "страниц": 480, "количество": 1, "место": "Абонемент, стеллаж 7, полка 2"}
        ]
    },
    "эрнест хемингуэй": {
        "книги": [
            {"название": "Старик и море", "страниц": 128, "количество": 2, "место": "Абонемент, стеллаж 8, полка 1"},
            {"название": "Прощай, оружие!", "страниц": 352, "количество": 1, "место": "Абонемент, стеллаж 8, полка 1"}
        ]
    },
    "антуан де сент-экзюпери": {
        "книги": [
            {"название": "Маленький принц", "страниц": 96, "количество": 4, "место": "Читальный зал, стеллаж 6, полка 3"}
        ]
    }
}


user_state = {}

# Функция для создания главного меню
def main_menu():
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    markup.add(
        types.KeyboardButton("Поиск по автору"),
        types.KeyboardButton("Поиск по названию"),
        types.KeyboardButton("Поиск по автору и названию"),
        types.KeyboardButton("Полный каталог"),
        types.KeyboardButton("Помощь")
    )
    return markup

# Создаем бота
bot = telebot.TeleBot(TOKEN)

# Обработчик команды /start
@bot.message_handler(commands=['start'])
def send_welcome(message):
    bot.send_message(
        message.chat.id, 
        "Привет! Я бот школьной библиотеки. Выбери действие в меню:(на каждый новый запрос введите /start)",
        reply_markup=main_menu()
    )

# Обработчик текстовых сообщений
@bot.message_handler(func=lambda message: True)
def handle_message(message):
    text = message.text
    chat_id = message.chat.id
    
    if text == "Поиск по автору":
        user_state[chat_id] = "author"
        bot.send_message(chat_id, "Введи имя автора:")
    
    elif text == "Поиск по названию":
        user_state[chat_id] = "title"
        bot.send_message(chat_id, "Введи название книги:")
    
    elif text == "Поиск по автору и названию":
        user_state[chat_id] = "both"
        bot.send_message(chat_id, "Введи автора и название через пробел:")
    
    elif text == "Полный каталог":
        show_catalog(chat_id)
    
    elif text == "Помощь":
        bot.send_message(chat_id, "Выбери пункт меню и следуй инструкциям.")
    
    elif chat_id in user_state:
        if user_state[chat_id] == "author":
            search_by_author(chat_id, text)
        elif user_state[chat_id] == "title":
            search_by_title(chat_id, text)
        elif user_state[chat_id] == "both":
            search_by_both(chat_id, text)
        
        del user_state[chat_id]

def search_by_author(chat_id, author):
    author_lower = author.lower().strip()
    found = False
    
    for author_name, data in library_catalog.items():
        if author_lower in author_name:
            books = data["книги"]
            response = f"Книги {author_name.title()}:\n\n"
            for i, book in enumerate(books, 1):
                response += f'{i}. "{book["название"]}"\n'
                response += f"   Страниц: {book['страниц']}\n"
                response += f"   В наличии: {book['количество']} шт.\n"
                response += f"   Место: {book['место']}\n\n"
            bot.send_message(chat_id, response)
            found = True
            break
    
    if not found:
        bot.send_message(chat_id, "Книг этого автора нет.\nупс, наверное, тебе придётся обратиться в другую библиотеку...")

def search_by_title(chat_id, title):
    title_lower = title.lower().strip()
    found_books = []
    
    for author_name, data in library_catalog.items():
        for book in data["книги"]:
            if title_lower in book["название"].lower():
                found_books.append({**book, "автор": author_name.title()})
    
    if found_books:
        response = f'Найдено по запросу "{title}":\n\n'
        for i, book in enumerate(found_books, 1):
            response += f'{i}. "{book["название"]}"\n'
            response += f"   Автор: {book['автор']}\n"
            response += f"   Страниц: {book['страниц']}\n"
            response += f"   В наличии: {book['количество']} шт.\n"
            response += f"   Место: {book['место']}\n\n"
        bot.send_message(chat_id, response)
    else:
        bot.send_message(chat_id, "Такой книги нет.\nупс, наверное, тебе придётся обратиться в другую библиотеку...")

def search_by_both(chat_id, query):
    parts = query.split(' ', 1)
    if len(parts) < 2:
        bot.send_message(chat_id, "Введи и автора, и название!")
        return
    
    author = parts[0].lower()
    title = parts[1].lower()
    
    for author_name, data in library_catalog.items():
        if author in author_name.lower():
            for book in data["книги"]:
                if title in book["название"].lower():
                    response = (
                        f'Книга найдена!\n\n'
                        f'Название: "{book["название"]}"\n'
                        f'Автор: {author_name.title()}\n'
                        f'Страниц: {book["страниц"]}\n'
                        f'В наличии: {book["количество"]} шт.\n'
                        f'Место: {book["место"]}'
                    )
                    bot.send_message(chat_id, response)
                    return
    
    bot.send_message(chat_id, "Такой книги нет.\nупс, наверное, тебе придётся обратиться в другую библиотеку...")

def show_catalog(chat_id):
    response = "КАТАЛОГ БИБЛИОТЕКИ:\n\n"
    for author_name, data in library_catalog.items():
        response += f"Автор: {author_name.title()}\n"
        for book in data["книги"]:
            response += f'• "{book["название"]}" - {book["страниц"]} стр.\n'
        response += "\n"
    bot.send_message(chat_id, response)

# Запуск бота
if __name__ == "__main__":
    print("Бот запущен...")
    bot.infinity_polling()